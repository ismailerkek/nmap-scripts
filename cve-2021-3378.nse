description = [[
FortiLogger 4.4.2.2 is affected by Arbitrary File Upload by sending a 
"Content-Type: image/png" header to Config/SaveUploadedHotspotLogoFile 
and then visiting Assets/temp/hotspot/img/logohotspot.asp.
 CVE-2021-3378
Manual inspection:
# curl -s -k  -X $'POST'
-H $'Host: <target>'
-H $'X-Requested-With: XMLHttpRequest'
-H $'Content-Length: 4'
-d $'\x0d\x0a\x0d\x0a'
$'http://<target>/shared/GetProductInfo'

References:
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3378'
https://nvd.nist.gov/vuln/detail/CVE-2021-3378
]]

---
-- @usage
-- nmap -p443 --script CVE-2021-3378.nse <target>
-- @output
-- PORT     STATE SERVICE
-- 5000/tcp open  upnp
-- | cve-2021-3378:
-- |   VULNERABLE:
-- |   FortiLogger 4.4.2.2 Arbitrary File Upload
-- |     State: VULNERABLE (Exploitable)
-- |     IDs:  CVE:CVE-2021-3378
-- |       FortiLogger 4.4.2.2 is affected by Arbitrary File Upload by sending a
-- |       "Content-Type: image/png" header to Config/SaveUploadedHotspotLogoFile
-- |       and then visiting Assets/temp/hotspot/img/logohotspot.asp.
-- |     Disclosure date: 2021-02-01
-- |     References:
-- |       https://github.com/erberkan/fortilogger_arbitrary_fileupload
-- |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3378


author = "Ismail Erkek"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"vuln", "exploit"}

local shortport = require "shortport"
local http = require "http"
local stdnse = require "stdnse"
local string = require "string"
local vulns = require "vulns"

portrule = shortport.http
portrule = shortport.portnumber({5000})
action = function(host, port)

    local vuln = {
        title = "FortiLogger 4.4.2.2 Arbitrary File Upload",
        state = vulns.STATE.NOT_VULN,
        IDS = { CVE = 'CVE-2021-3378' },
                description = [[
FortiLogger 4.4.2.2 is affected by Arbitrary File Upload by sending a 
"Content-Type: image/png" header to Config/SaveUploadedHotspotLogoFile 
and then visiting Assets/temp/hotspot/img/logohotspot.asp.]],

                references = {
           'https://github.com/erberkan/fortilogger_arbitrary_fileupload'
       },
       dates = {
           disclosure = {year = '2021', month = '02', day = '01'},
       },

    }

    local report = vulns.Report:new(SCRIPT_NAME, host, port)

    local uri = "/shared/GetProductInfo"

    local response = http.post(host, port, uri, {header= {["X-Requested-With"] = "XMLHttpRequest"}})

    if ( response.status == 200 ) then

    local title = string.match(response.body, '4.4.2.2')

        if (title == '4.4.2.2') then
                vuln.state = vulns.STATE.EXPLOIT
        else
                vuln.state = vulns.STATE.NOT_VULN
        end

    end

    return report:make_output (vuln)
end